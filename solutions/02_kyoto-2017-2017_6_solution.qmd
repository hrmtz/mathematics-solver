## 解答

箱は $n$ 個あり，各箱には $1,2,3,4,5$ が1枚ずつ入っているので，  
各箱から取り出すカードの選び方は $5$ 通りずつ，合計で $5^n$ 通りある。

取り出した順に並べてできる $n$ 桁の数を $X$ とする。  
各桁には $1,2,3,4,5$ のいずれかが1回ずつ使われるが，  
$3$ で割り切れるかどうかは，各桁の和（数字の和）が $3$ の倍数かどうかで判定できる  
（$10 \equiv 1 \pmod{3}$ なので，$3$ の倍数の判定法による）。

よって，$X$ が $3$ で割り切れる確率は，「$n$ 個の箱から取り出した数字の和が $3$ の倍数となる確率」と等しい。

各箱から取り出す数字を，その $3$ で割った余りで分類すると，
$$
1 \equiv 1,\quad 2 \equiv 2,\quad 3 \equiv 0,\quad 4 \equiv 1,\quad 5 \equiv 2 \pmod{3}
$$
より，  
余り $0,1,2$ となるカードはそれぞれ $1$ 種類, $2$ 種類, $2$ 種類ずつ存在する。

そこで，各箱ごとに「取り出したカードの $3$ で割った余り」を確率変数として見る。  
余り $0,1,2$ をそれぞれ $0,1,2$ と書き，その確率を求めると

- 余り $0$（すなわちカード $3$）：　$1$ 種類あるので　$\dfrac{1}{5}$，
- 余り $1$（カード $1$ または $4$）： $2$ 種類あるので　$\dfrac{2}{5}$，
- 余り $2$（カード $2$ または $5$）： $2$ 種類あるので　$\dfrac{2}{5}$

である。

ここで，それぞれの余りに $1$ を加えた量  
$$
Y = \text{（余り）} + 1 \in \{1,2,3\}
$$
を考えると，余り $0,1,2$ はそれぞれ $Y=1,2,3$ に対応する。  
このとき

- 余り $0$（$Y=1$）：　確率 $\dfrac{1}{5}$，
- 余り $1$（$Y=2$）：　確率 $\dfrac{2}{5}$，
- 余り $2$（$Y=3$）：　確率 $\dfrac{2}{5}$

である。

すると，$Y$ の期待値は
$$
E[Y] = 1\cdot \frac{1}{5} + 2\cdot \frac{2}{5} + 3\cdot \frac{2}{5}
      = \frac{1 + 4 + 6}{5}
      = \frac{11}{5}
$$
となる。一方，「余り」をそのまま $Z$ と書くと  
$Z = Y - 1$ なので，$Z$ の期待値は
$$
E[Z] = E[Y] - 1 = \frac{11}{5} - 1 = \frac{6}{5}
$$
となる。これは $3$ を法とする剰余環 $\mathbb{Z}/3\mathbb{Z}$ 上で考えると
$$
E[Z] \equiv \frac{6}{5} \equiv \frac{0}{5} \equiv 0 \pmod{3}
$$
すなわち，1箱あたりの「余り」の期待値は $3$ を法にして $0$ であることを示す。

しかし，ここから直接確率を計算するのは難しいので，  
より構造のはっきりした方法を用いる。

### 1箱ごとの確率を3成分ベクトルで表す

「1箱から取り出す余りが $0,1,2$ となる確率」を成分にもつベクトルを
$$
v = \left(\frac{1}{5},\ \frac{2}{5},\ \frac{2}{5}\right)
$$
とする。ただし，左から順に「余り $0$，余り $1$，余り $2$」の確率である。

$n$ 個の箱からの余りの「和」を $3$ で割った余りの分布を考える。  
箱は互いに独立なので，余りの分布は「確率ベクトル $v$ の畳み込み」を繰り返したものになる。  
これは，$3$ を法として加法する確率過程なので，循環行列を使うとよい。

余りの和の分布をベクトルで $w_n = (p_n(0), p_n(1), p_n(2))$ と表す。  
ここで $p_n(r)$ は「$n$ 個の箱の余りの和が $r$（mod 3）となる確率」である。  
明らかに $w_1 = v$ であり，一般に
$$
w_{n+1} = w_n A
$$
という形で更新される。ただし $A$ は，1箱分（余り1個分）の作用を表す $3\times 3$ 行列である。

具体的に，今の状況では
- 現在の和の余りが $0$ で，次に $0,1,2$ を足す確率はそれぞれ $\dfrac{1}{5}, \dfrac{2}{5}, \dfrac{2}{5}$，
- 現在の和の余りが $1$ で，次に $0,1,2$ を足す確率も同様，
- 現在の和の余りが $2$ でも同様，

であるから，行列 $A$ は「同じ確率ベクトル $v$ が，各行に循環的に並んだ形」になる。  
余り $r$ から余り $s$ へ移る確率を $a_{rs}$ とすると
$$
A =
\begin{pmatrix}
a_{00} & a_{01} & a_{02}\\
a_{10} & a_{11} & a_{12}\\
a_{20} & a_{21} & a_{22}
\end{pmatrix}
=
\begin{pmatrix}
\frac{1}{5} & \frac{2}{5} & \frac{2}{5}\\
\frac{2}{5} & \frac{1}{5} & \frac{2}{5}\\
\frac{2}{5} & \frac{2}{5} & \frac{1}{5}
\end{pmatrix}
$$
となる（例えば，余り $1$ に余り $2$ が足されると余り $0$ になる，などを反映した循環的配置である）。

したがって
$$
w_n = (1,0,0) A^n
$$
と書ける（最初は和が $0$ で確定しているので $(1,0,0)$ からスタート）。

よって，求めたいのは $w_n$ の第1成分
$$
p_n(0) = \text{和の余りが $0$ となる確率}
$$
である。

### 行列 $A$ の固有値・固有ベクトル

$A$ は，すべての行和・列和が $1$ となっている行列であり，
$$
(1,1,1) A = (1,1,1)
$$
なので，固有値 $1$ をもつ。これに対応する固有ベクトルとして $(1,1,1)$ がある。

他の固有値は，行列 $A$ の構造から「対称な循環行列」であることを用いると，
$$
\lambda_1 = 1,\quad \lambda_2 = \lambda_3 = -\frac{1}{5}
$$
となる。実際，$A$ のトレース（対角成分の和）は
$$
\mathrm{tr}(A) = \frac{1}{5} + \frac{1}{5} + \frac{1}{5} = \frac{3}{5}
$$
であるから，固有値の和
$$
\lambda_1 + \lambda_2 + \lambda_3 = \frac{3}{5}
$$
を満たす必要がある。一つは $\lambda_1 = 1$ と分かっているので，
$$
1 + \lambda_2 + \lambda_3 = \frac{3}{5}
\quad\Rightarrow\quad
\lambda_2 + \lambda_3 = -\frac{2}{5}
$$
となる。一方，$A$ は対称行列なので実固有値を3つもつが，  
循環性から大きさが等しく符号が反対の2つの固有値が出ることが分かる（高次のフーリエ変換の性質に対応）。  
したがって $\lambda_2 = \lambda_3$ として
$$
2\lambda_2 = -\frac{2}{5}\quad\Rightarrow\quad \lambda_2 = \lambda_3 = -\frac{1}{5}
$$
を得る。

対応する固有ベクトルとしては
$$
\begin{aligned}
&\lambda_1 =1 \quad\Rightarrow\quad (1,1,1),\\
&\lambda_2 = -\frac{1}{5} \quad\Rightarrow\quad (1,-1,0),\\
&\lambda_3 = -\frac{1}{5} \quad\Rightarrow\quad (1,0,-1)
\end{aligned}
$$
などがとれる（実際に $A(1,-1,0)^T$ を計算すると $-\dfrac{1}{5}(1,-1,0)^T$ になる）。

従って，初期ベクトル $(1,0,0)$ をこれらの固有ベクトルの一次結合で表し，
それに $A^n$ を作用させればよい。

### 初期ベクトルの分解

$(1,0,0)$ を固有ベクトルの一次結合で表すため，
$$
(1,0,0) = \alpha (1,1,1) + \beta (1,-1,0) + \gamma (1,0,-1)
$$
とおく。両辺の各成分を比較すると
$$
\begin{cases}
1 = \alpha + \beta + \gamma,\\
0 = \alpha - \beta,\\
0 = \alpha - \gamma
\end{cases}
$$
となるので，$0=\alpha-\beta$ より $\beta = \alpha$，$0=\alpha-\gamma$ より $\gamma = \alpha$ である。  
これを1行目に代入して
$$
1 = \alpha + \alpha + \alpha = 3\alpha
\quad\Rightarrow\quad
\alpha = \frac{1}{3}
$$
となる。よって
$$
\beta = \gamma = \frac{1}{3}
$$
であり，
$$
(1,0,0) = \frac{1}{3}(1,1,1) + \frac{1}{3}(1,-1,0) + \frac{1}{3}(1,0,-1)
$$
と書ける。

### $A^n$ の作用と確率の計算

固有値と固有ベクトルの関係から
$$
A^n (1,1,1)^T = 1^n (1,1,1)^T = (1,1,1)^T,
$$
$$
A^n (1,-1,0)^T = \left(-\frac{1}{5}\right)^n (1,-1,0)^T,
$$
$$
A^n (1,0,-1)^T = \left(-\frac{1}{5}\right)^n (1,0,-1)^T
$$
が成り立つ。

したがって
$$
\begin{aligned}
w_n
&= (1,0,0) A^n\\
&= \left\{\frac{1}{3}(1,1,1) + \frac{1}{3}(1,-1,0) + \frac{1}{3}(1,0,-1)\right\} A^n\\
&= \frac{1}{3}(1,1,1) A^n + \frac{1}{3}(1,-1,0) A^n + \frac{1}{3}(1,0,-1) A^n\\
&= \frac{1}{3}(1,1,1)
  + \frac{1}{3}\left(-\frac{1}{5}\right)^n (1,-1,0)
  + \frac{1}{3}\left(-\frac{1}{5}\right)^n (1,0,-1)
\end{aligned}
$$
となる。

このベクトルの第1成分（余り $0$ となる確率）は
$$
p_n(0)
= \frac{1}{3}\cdot 1
+ \frac{1}{3}\left(-\frac{1}{5}\right)^n\cdot 1
+ \frac{1}{3}\left(-\frac{1}{5}\right)^n\cdot 1
= \frac{1}{3} + \frac{2}{3}\left(-\frac{1}{5}\right)^n
$$
である。

よって，元の問題で求める「$X$ が $3$ で割り切れる確率」は
$$
\boxed{\dfrac{1}{3} + \dfrac{2}{3}\left(-\dfrac{1}{5}\right)^n}
$$
となる。