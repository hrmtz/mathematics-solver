## 解答

縦4個，横4個のマスに $1,2,3,4$ を入れ，どの行にもどの列にも同じ数字が1回ずつ現れるような入れ方を数える問題である。  
これは「4次のラテン方格（Latin square）」の個数を数える問題と同じである。ただし，この問題では行番号・列番号・数字のラベル（$1,2,3,4$）は固定されている（入れ替えても同一とはみなさない）。

以下，行・列をそれぞれ「上から1行目〜4行目」「左から1列目〜4列目」と呼ぶ。

---

### (1) 第1行を固定する

各行には $1,2,3,4$ が1回ずつ現れるので，第1行には $1,2,3,4$ を並べた順列が入る。  
しかし，横・縦とも対称性があるので，第1行を

$$
(1,2,3,4)
$$

と固定しても一般性を失わない，というわけではないことに注意する。  
ただし，今回求めるのは「第1行も含めラベル付きで区別した配置の総数」であるから，まずは「第1行を $(1,2,3,4)$ と固定したときの可能な配置数 $N$」を求め，最後に

- $1,2,3,4$ の数字ラベルの入れ替え：$4!$
- 列の並べ替え：$4!$

で補正する方針をとる。

よって，以下では

> 第1行を $(1,2,3,4)$ と固定したもとで，条件を満たす $4\times4$ の配置数を $N$ とおく。

---

### (2) 第2行の形を分類する

第1行が $(1,2,3,4)$ のとき，各列にも $1,2,3,4$ が1回ずつ現れなければならないので，第2行以降も $1,2,3,4$ の順列になる。

第2行に入る $(a,b,c,d)$ は，
- どの列でも，同じ数字が2回現れてはならないので，
  - 第1列には $1$ 以外の $2,3,4$ のいずれか  
  - 第2列には $2$ 以外の $1,3,4$ のいずれか  
  - 第3列には $3$ 以外  
  - 第4列には $4$ 以外  

となる，すなわち「$(1,2,3,4)$ とどの位置でも一致しない順列」である。これを $(1,2,3,4)$ の「完全非一致順列（derangement）」という。

長さ4の完全非一致順列は，数え上げると

- $(2,1,4,3)$
- $(2,3,4,1)$
- $(2,4,1,3)$
- $(3,1,4,2)$
- $(3,4,1,2)$
- $(4,1,2,3)$
- $(4,3,1,2)$
- $(4,3,2,1)$

の8通りあるが，このまま8通りを個別に追うのは煩雑である。

ここで「列の並べ替え」による対称性を利用する。

第1行を $(1,2,3,4)$ と固定したまま，4本の列をまとめて入れ替えてよい。この操作は，  
「第2行の並びの形を，ある1つの標準形にそろえる」ことに使える。

完全非一致順列のうち，代表として例えば

$$
(2,3,4,1)
$$

を標準形として選ぶ。  
すると「列の並べ替えにより，第2行を $(2,3,4,1)$ の形にしてしまう」ことができ，これは第1行 $(1,2,3,4)$ との関係（完全非一致）を保つ。

よって，

> 第2行を $(2,3,4,1)$ と固定して場合分けしても，最終的な総数は，あとで列の入れ替え $4!$ を掛けることで補正できる。

したがって，以下では

- 第1行：$(1,2,3,4)$
- 第2行：$(2,3,4,1)$

と固定して数え，その個数を $M$ とおく。  
この $M$ から $N$，さらに最終解を求める。

---

### (3) 第3行の決定

第1行，第2行が

- 行1：$(1,2,3,4)$
- 行2：$(2,3,4,1)$

であるとき，第3行を $(x_1,x_2,x_3,x_4)$ とおく。

各列ごとに，すでに出ている数字は次の通り。

- 第1列には $1,2$ が出ている → 第3行第1列 $x_1$ は $\{3,4\}$ のいずれか
- 第2列には $2,3$ → $x_2\in\{1,4\}$
- 第3列には $3,4$ → $x_3\in\{1,2\}$
- 第4列には $4,1$ → $x_4\in\{2,3\}$

さらに，各行にも $1,2,3,4$ が1回ずつ現れねばならないので，

$$
\{x_1,x_2,x_3,x_4\} = \{1,2,3,4\}
$$

が成り立つ。  
この条件のもとで $(x_1,x_2,x_3,x_4)$ をすべて列挙する。

候補を丁寧に調べると，

- $x_1=3$ のとき：
  - 残り $\{1,2,4\}$ を $\{x_2,x_3,x_4\}$ に割り当てる。
  - $x_2\in\{1,4\}$，$x_3\in\{1,2\}$，$x_4\in\{2,3\}$ だが $x_4$ は $\{1,2,4\}$ との共通部分より $\{2\}$ のみ可。
  - よって $x_4=2$ が確定し，残り $\{1,4\}$ を $x_2,x_3$ に割当てる。
  - $x_2\in\{1,4\}$，$x_3\in\{1,2\}$ かつ $x_3\neq2$ とは限らないが，ここでは $\{1,4\}$ を使うので
    - $x_2=1,x_3=4$ （可）
    - $x_2=4,x_3=1$（可）
  - よって $(x_1,x_2,x_3,x_4)=(3,1,4,2)$ または $(3,4,1,2)$

- $x_1=4$ のとき：
  - 残り $\{1,2,3\}$ を $\{x_2,x_3,x_4\}$ へ。
  - $x_2\in\{1,4\}$ から $x_2\in\{1\}$，よって $x_2=1$。
  - 残り $\{2,3\}$ を $x_3,x_4$ に割り当てる。
  - $x_3\in\{1,2\}$ より $x_3=2$，$x_4\in\{2,3\}$ より $x_4=3$。
  - よって $(x_1,x_2,x_3,x_4)=(4,1,2,3)$

以上から，第3行として取り得る並びは

$$
(3,1,4,2),\quad (3,4,1,2),\quad (4,1,2,3)
$$

の3通りである。

---

### (4) 第4行はほぼ一意に決まる

第4行 $(y_1,y_2,y_3,y_4)$ は，各列に $1,2,3,4$ が1回ずつ現れる条件から「その列でまだ出ていない数字」で一意に決まる。  
よって，上で求めた第3行の候補3通りについて，第4行の形を決めればよい。

#### (i) 第3行 $(3,1,4,2)$ の場合

- 列1：$1,2,3$ が出ている → 残り $4$ → $y_1=4$
- 列2：$2,3,1$ → 残り $4$ → $y_2=4$

となり，第4行の中に $4$ が2回現れてしまう。よって行として $1,2,3,4$ が1回ずつにならない。  
したがってこの場合は不適。

#### (ii) 第3行 $(3,4,1,2)$ の場合

- 列1：$1,2,3$ → 残り $4$ → $y_1=4$
- 列2：$2,3,4$ → 残り $1$ → $y_2=1$
- 列3：$3,4,1$ → 残り $2$ → $y_3=2$
- 列4：$4,1,2$ → 残り $3$ → $y_4=3$

となり，第4行は $(4,1,2,3)$ となる。この並びは行としても $1,2,3,4$ が1回ずつなので条件を満たす。

#### (iii) 第3行 $(4,1,2,3)$ の場合

- 列1：$1,2,4$ → 残り $3$ → $y_1=3$
- 列2：$2,3,1$ → 残り $4$ → $y_2=4$
- 列3：$3,4,2$ → 残り $1$ → $y_3=1$
- 列4：$4,1,3$ → 残り $2$ → $y_4=2$

で，第4行は $(3,4,1,2)$ となり，やはり行としての条件も満たす。

---

### (5) 第1行を $(1,2,3,4)$，第2行を $(2,3,4,1)$ と固定したときの個数 $M$

上の考察より，第3行の候補3通りのうち有効なのは

- 第3行 $(3,4,1,2)$，第4行 $(4,1,2,3)$
- 第3行 $(4,1,2,3)$，第4行 $(3,4,1,2)$

の2通りである。  
したがって，

$$
M = 2
$$

となる。

---

### (6) 第1行を $(1,2,3,4)$ としたときの総数 $N$

ここまでの議論では，

- 第1行 $(1,2,3,4)$ を固定
- さらに列の並べ替えを用いて，第2行を $(2,3,4,1)$ に正規化
- そのもとでの可能な配置数が $M=2$

であった。

しかし実際には，

- 第1行 $(1,2,3,4)$ を固定しただけの状況では，
  - 第2行は「完全非一致順列」8通りあり，
  - それぞれは列の並べ替えにより上の標準形 $(2,3,4,1)$ に移される
  - ただし，そのとき列の並べ替えは一意である（第1行も $(1,2,3,4)$ に保つようにするため）

よって「第1行固定」だけの場合の配置数 $N$ は，

- 「第2行の完全非一致順列の選び方 8通り」
- ×「標準形の場合の配置数 $M=2$」
- ÷「第2行を同一視するために用いた列の並べ替えの重複（=1通り）」

より，

$$
N = 8\times 2 = 16
$$

である。

---

### (7) 第1行も数字ラベルも自由な場合

問題では第1行の並びも数字ラベルも区別する（具体的に，マスごとの数字配置そのものを数える）から，

- 第1行の並び $(1,2,3,4)$ の代わりに，任意の順列をとってよい自由度：$4!$
- さらに，ここまでの議論では数字のラベル $(1,2,3,4)$ 自体を固定していたが，実際には数字そのものの入れ替え（例：全ての「1」を「2」に，「2」を「3」に…など）も別の配置として区別されるので，数字ラベルの置換の自由度：$4!$

がある。

しかし注意すべきは，すでに $N=16$ を求める際に「第1行を $(1,2,3,4)$ に固定して」数えているだけで，数字ラベルの入れ替えはまだ考えていない。  
したがって，最終的な総数は

$$
4! \times N = 24 \times 16 = 384
$$

となる。

---

以上より，求める入れ方は

$$
\boxed{384\ \text{通り}}
$$

である。